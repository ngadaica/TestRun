@model TrueTestRun.Models.Request
@{
    ViewBag.Title = HttpContext.GetGlobalResourceObject("Resources", "ApprovalForm").ToString() + " - " + Model.RequestID;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentUser = ViewBag.CurrentUser as TrueTestRun.Models.User;
    var currentStep = ViewBag.CurrentStep as TrueTestRun.Models.WorkflowStep;

    bool canApprove = ViewBag.CanApprove ?? false;
    bool canEdit = ViewBag.CanEdit ?? false;
    bool isApprovalStep = canApprove;
    bool isDataEntryStep = canEdit && !canApprove;
    bool isFinalApprovalStep = isApprovalStep && currentStep != null && currentStep.Index == 10;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@HttpContext.GetGlobalResourceObject("Resources", "ApprovalForm"): @Model.RequestID</h2>
    <a href="javascript:history.back()" class="btn btn-secondary">
        <span style="font-size:1em;">⬅️</span> @HttpContext.GetGlobalResourceObject("Resources", "Back")
    </a>
</div>

<!-- BẢNG THÔNG TIN REQUEST -->
<div class="card mb-4">
    <div class="card-header">
        <h5><span style="font-size:1.1em;">📄</span> @HttpContext.GetGlobalResourceObject("Resources", "RequestInformation")</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">@HttpContext.GetGlobalResourceObject("Resources", "CreatedDate")</th>
                        <th scope="col">@HttpContext.GetGlobalResourceObject("Resources", "CurrentStep")</th>
                        <th scope="col">@HttpContext.GetGlobalResourceObject("Resources", "Status")</th>
                        <th scope="col">@HttpContext.GetGlobalResourceObject("Resources", "Actions")</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <span class="fw-bold text-primary">@Model.RequestID</span>
                        </td>
                        <td>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>
                            @if (currentStep != null)
                            {
                                <span class="badge bg-primary">@currentStep.StepName</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">@HttpContext.GetGlobalResourceObject("Resources", "Unknown")</span>
                            }
                        </td>
                        <td>
                            @if (Model.IsCompleted)
                            {
                                <span class="badge bg-success">
                                    <span style="font-size:0.9em;">✅</span> @HttpContext.GetGlobalResourceObject("Resources", "Completed")
                                </span>
                            }
                            else if (Model.IsRejected)
                            {
                                <span class="badge bg-danger">
                                    <span style="font-size:0.9em;">❌</span> @HttpContext.GetGlobalResourceObject("Resources", "Rejected")
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">
                                    <span style="font-size:0.9em;">⏰</span> @HttpContext.GetGlobalResourceObject("Resources", "Processing")
                                </span>
                            }
                        </td>
                        <td>
                            @if (isApprovalStep)
                            {
                                <span class="text-success"><span style="font-size:0.9em;">🔖</span> @HttpContext.GetGlobalResourceObject("Resources", "Approving")</span>
                            }
                            else if (isDataEntryStep)
                            {
                                <span class="text-warning"><span style="font-size:0.9em;">✏️</span> @HttpContext.GetGlobalResourceObject("Resources", "DataEntry")</span>
                            }
                            else
                            {
                                <span class="text-muted">@HttpContext.GetGlobalResourceObject("Resources", "ViewInformation")</span>
                            }
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- PREVIEW EXCEL PHÓNG TO -->
<div class="card mb-4">
    <div class="card-header">
        <h5><span style="font-size:1.1em;">📊</span> @HttpContext.GetGlobalResourceObject("Resources", "ExcelPreview") - @Model.RequestID</h5>
    </div>
    <div class="card-body text-center p-2">
        <div class="excel-preview-container">
            <img src="@Url.Action("PreviewImage", "Request", new { id = Model.RequestID })"
                 class="img-fluid excel-preview-large"
                 alt="Excel Preview" />
        </div>
    </div>
</div>
<div class="text-center mb-4">
    <div class="card border-info">
        <div class="card-body py-3">
            <h6 class="card-title mb-3">
                <span style="font-size:1.1em;">📎</span> @HttpContext.GetGlobalResourceObject("Resources", "AttachedDocuments")
            </h6>
            @Html.Partial("_DocumentViewButton", Model.RequestID)
            <div class="mt-2">
                <small class="text-muted">
                    <span style="font-size:0.9em;">ℹ️</span>
                    @HttpContext.GetGlobalResourceObject("Resources", "ClickToViewDocuments")
                </small>
            </div>
        </div>
    </div>
</div>

<!-- FORM PHÊ DUYỆT Ở DƯỚI CÙNG -->
@if (isApprovalStep)
{
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <span style="font-size:1em;">🔖</span>
                @if (isFinalApprovalStep)
                {
                    <span>@HttpContext.GetGlobalResourceObject("Resources", "FinalApproval")</span>
                }
                else
                {
                    <span>@HttpContext.GetGlobalResourceObject("Resources", "ApprovalAndStamp")</span>
                }
            </h6>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("ProcessApproval", "Approval", FormMethod.Post, new { id = "approvalForm" }))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("RequestID", Model.RequestID)

                <div class="row justify-content-center">
                    <div class="col-md-8">

                        @if (isFinalApprovalStep)
                        {
                            <!-- CHỈ HIỂN THỊ COMMENT CHO BƯỚC CUỐI CÙNG (G.M) -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <span style="font-size:0.9em;">💬</span>
                                    @HttpContext.GetGlobalResourceObject("Resources", "FinalApprovalNotes")
                                </label>
                                <textarea name="Comments" class="form-control" rows="4"
                                          placeholder="@HttpContext.GetGlobalResourceObject("Resources", "EnterGMNotes")"></textarea>
                                <div class="form-text">
                                    <span style="font-size:0.9em;">ℹ️</span>
                                    @HttpContext.GetGlobalResourceObject("Resources", "ApprovalHistoryNote")
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- CHỈ HIỂN THỊ CHECKBOX ĐÓNG DẤU CHO CÁC BƯỚC KHÁC -->
                            <div class="form-check mb-3 text-center">
                                <input class="form-check-input" type="checkbox" name="shouldStamp" value="true" checked id="shouldStampCheck">
                                <label class="form-check-label" for="shouldStampCheck">
                                    <span style="font-size:0.9em;">🔖</span> @HttpContext.GetGlobalResourceObject("Resources", "StampWithApproval")
                                </label>
                            </div>
                        }

                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="approve" class="btn btn-success btn-lg">
                                <span style="font-size:1em;">✓</span>
                                @if (isFinalApprovalStep)
                                {
                                    <span>@HttpContext.GetGlobalResourceObject("Resources", "FinalApproval")</span>
                                }
                                else
                                {
                                    <span>@HttpContext.GetGlobalResourceObject("Resources", "Approve")</span>
                                }
                            </button>
                            @if (isFinalApprovalStep)
                            {
                                <!-- Nút từ chối cho G.M - submit trực tiếp -->
                                <button type="submit" name="action" value="reject" class="btn btn-danger btn-lg">
                                    <span style="font-size:1em;">❌</span> @HttpContext.GetGlobalResourceObject("Resources", "Reject")
                                </button>
                            }
                            else
                            {
                                <!-- Nút từ chối cho các bước trước - mở modal -->
                                <button type="button" class="btn btn-danger btn-lg" id="btnReject">
                                    <span style="font-size:1em;">❌</span> @HttpContext.GetGlobalResourceObject("Resources", "Reject")
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

@if (isDataEntryStep)
{
    <div class="text-center">
        @using (Html.BeginForm("ProcessApproval", "Approval", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            @Html.Hidden("RequestID", Model.RequestID)

            <button type="submit" name="action" value="complete" class="btn btn-success btn-lg">
                <span style="font-size:1em;">✓</span> @HttpContext.GetGlobalResourceObject("Resources", "CompleteAndForward")
            </button>
        }
    </div>
}

<!-- MODAL TỪ CHỐI CHO CÁC BƯỚC TRƯỚC G.M -->
@if (isApprovalStep && !isFinalApprovalStep)
{
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="rejectModalLabel">
                        <span style="font-size:1em;">❌</span> @HttpContext.GetGlobalResourceObject("Resources", "RejectApproval")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="rejectForm">
                        @Html.AntiForgeryToken()
                        @Html.Hidden("RequestID", Model.RequestID)
                        <input type="hidden" name="action" value="reject" />

                        <div class="mb-3">
                            <label for="rejectReason" class="form-label fw-bold">
                                <span style="font-size:0.9em;">💬</span> @HttpContext.GetGlobalResourceObject("Resources", "RejectReason")
                            </label>
                            <textarea name="Comments" id="rejectReason" class="form-control" rows="4"
                                      placeholder="@HttpContext.GetGlobalResourceObject("Resources", "EnterRejectReason")"></textarea>
                            <div class="form-text">
                                <span style="font-size:0.9em;">ℹ️</span> @HttpContext.GetGlobalResourceObject("Resources", "RejectReasonOptional")
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="alert alert-warning d-flex align-items-center">
                                <span style="font-size:1.2em; margin-right: 8px;">⚠️</span>
                                <div>
                                    <strong>@HttpContext.GetGlobalResourceObject("Resources", "Warning"):</strong> @HttpContext.GetGlobalResourceObject("Resources", "RejectWarning")
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <span style="font-size:0.9em;">↩️</span> @HttpContext.GetGlobalResourceObject("Resources", "Cancel")
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmReject">
                        <span style="font-size:0.9em;">❌</span> @HttpContext.GetGlobalResourceObject("Resources", "ConfirmReject")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            @if (isFinalApprovalStep)
            {
                <text>
                // Logic cho bước cuối cùng (G.M) - có textarea sẵn
                $('#approvalForm').on('submit', function (e) {
                    var $form = $(this);
                    var $submitButton = $(document.activeElement);
                    var action = $submitButton.val();

                    if (action === 'reject') {
                        if (!confirm('@HttpContext.GetGlobalResourceObject("Resources", "ConfirmRejectRequest")')) {
                            e.preventDefault();
                            return false;
                        }
                    }

                    if (action === 'approve') {
                        if (!confirm('@HttpContext.GetGlobalResourceObject("Resources", "ConfirmFinalApproval")')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                });

                // Character counter for textarea (chỉ cho bước cuối cùng)
                $('textarea[name="Comments"]').on('input', function() {
                    var len = $(this).val().length;
                    var info = $(this).siblings('.form-text');
                    info.html(`<span style="font-size:0.9em;">ℹ️</span> @HttpContext.GetGlobalResourceObject("Resources", "CharactersEntered")`.replace('{0}', len) + ' @HttpContext.GetGlobalResourceObject("Resources", "ApprovalHistoryNote")');
                });
                </text>
            }
            else
            {
                <text>
                // Logic cho các bước trước (không phải G.M) - dùng modal
                $('#approvalForm').on('submit', function (e) {
                    var $form = $(this);
                    var $submitButton = $(document.activeElement);
                    var action = $submitButton.val();

                    if (action === 'approve') {
                        if (!confirm('@HttpContext.GetGlobalResourceObject("Resources", "ConfirmApprove")')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                });

                // Mở modal khi nhấn nút từ chối
                $('#btnReject').on('click', function() {
                    $('#rejectModal').modal('show');
                });

                // Xử lý khi nhấn "Xác nhận từ chối" trong modal
                $('#confirmReject').on('click', function() {
                    var reason = $('#rejectReason').val().trim();

                    if (!confirm('@HttpContext.GetGlobalResourceObject("Resources", "ConfirmRejectRequest")')) {
                        return;
                    }

                    // Tạo form ẩn để submit
                    var form = $('<form>', {
                        'method': 'POST',
                        'action': '@Url.Action("ProcessApproval", "Approval")'
                    });

                    // Thêm các field cần thiết
                    form.append($('<input>', {
                        'type': 'hidden',
                        'name': '__RequestVerificationToken',
                        'value': $('input[name="__RequestVerificationToken"]').val()
                    }));

                    form.append($('<input>', {
                        'type': 'hidden',
                        'name': 'RequestID',
                        'value': '@Model.RequestID'
                    }));

                    form.append($('<input>', {
                        'type': 'hidden',
                        'name': 'action',
                        'value': 'reject'
                    }));

                    form.append($('<input>', {
                        'type': 'hidden',
                        'name': 'Comments',
                        'value': reason
                    }));

                    // Submit form
                    $('body').append(form);
                    form.submit();
                });

                // Character counter cho modal textarea
                $('#rejectReason').on('input', function() {
                    var len = $(this).val().length;
                    var info = $(this).siblings('.form-text');
                    info.html(`<span style="font-size:0.9em;">ℹ️</span> @HttpContext.GetGlobalResourceObject("Resources", "CharactersEntered")`.replace('{0}', len) + ' @HttpContext.GetGlobalResourceObject("Resources", "RejectReasonOptional")');
                });
                </text>
            }

            // Handle data entry step
            if ($('button[name="action"][value="complete"]').length > 0) {
                $('button[name="action"][value="complete"]').on('click', function(e) {
                    if (!confirm('@HttpContext.GetGlobalResourceObject("Resources", "ConfirmComplete")')) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
        });
    </script>
}

<style>
    .excel-preview-container {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 10px;
        margin: 0 auto;
    }

    .excel-preview-large {
        max-width: 100%;
        min-height: 600px;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .card-header h6 {
        margin: 0;
        font-weight: 600;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        white-space: nowrap;
    }

    .table td {
        vertical-align: middle;
    }

    .badge {
        font-size: 0.75em;
    }

    .btn {
        border-radius: 6px;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.125rem;
    }

    /* THÊM: Style đặc biệt cho bước cuối cùng */
    .final-approval-highlight {
        border: 2px solid #ffc107;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    }

    /* Style cho modal */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        border-radius: 12px 12px 0 0;
    }

    .modal-footer {
        border-radius: 0 0 12px 12px;
    }

    .btn-close-white {
        filter: brightness(0) invert(1);
    }
</style>